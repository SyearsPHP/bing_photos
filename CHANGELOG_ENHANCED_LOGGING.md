# 更新日志 - 增强日志和问题修复

## 版本更新内容

### ✅ 已解决的问题

1. **增强API接口日志输出**
   - 现在会打印使用的API源名称（NetEase、KuGou、QQ Music）
   - 显示原始元数据和标准化后的搜索词
   - 显示完整的搜索URL和参数
   - 显示所有搜索结果及其评分
   - 显示尝试的歌词API端点

2. **修复macOS Mach Port错误**
   - 添加环境变量抑制 `error messaging the mach port for IMKCFRunLoopWakeUpReliable` 警告
   - 这是PyQt6与macOS输入法框架的已知交互问题
   - 不影响功能，现已静默处理

3. **解释元数据到搜索结果的不匹配问题**
   - 提供详细文档说明为什么正确的元数据可能得到错误的结果
   - 主要原因：版权限制导致原唱不在搜索结果中
   - 周杰伦等热门艺人的歌词在各大平台都有严格的版权保护

### 🆕 新增功能

1. **详细的搜索结果评分显示**
   ```
   Found 20 songs, top 10 scores:
     1. [ 18] 沈幼楚 - 青花瓷周杰伦（正式版）
     2. [ 15] 周杰伦, 李玟 - 刀马旦
     3. [ 10] 刘芳 - 青花瓷
     ...
   ```

2. **逐步的歌词获取日志**
   ```
   Attempting to get lyrics from top matches:
     Trying song #2733603631: 沈幼楚 - 青花瓷周杰伦（正式版） (score: 18)
       Lyrics API: https://music.163.com/api/song/lyric?id=2733603631&lv=1
       ✓ SUCCESS: Found lyrics for: 沈幼楚 - 青花瓷周杰伦（正式版）
   ```

3. **测试工具**
   - `test_logging.py` - 测试单个歌曲的下载过程和日志输出
   - `test_all_sources.py` - 测试所有API源并显示各自的结果

4. **文档**
   - `LOGGING_AND_TROUBLESHOOTING.md` - 详细的日志说明和问题排查指南
   - README更新，包含常见问题的具体示例

### 📊 测试示例

测试歌曲：周杰伦 - 青花瓷

**NetEase (网易云音乐):**
- 搜索返回20首歌
- 原唱不在结果中（版权限制）
- 最佳匹配：沈幼楚 - 青花瓷周杰伦（正式版），评分18分
- 结果：✓ 成功（下载了翻唱版本）

**KuGou (酷狗音乐):**
- 搜索无结果
- 结果：✗ 失败

**QQ Music (QQ音乐):**
- 搜索返回20首歌
- 找到原唱：周杰伦 - 青花瓷，评分40分（完美匹配！）
- 但歌词不可用（版权限制）
- 结果：✗ 失败

### 🎯 重要说明

#### 关于"下载了错误的歌曲"问题

这**不是bug**，而是数据可用性问题：

1. **评分系统正常工作** - 当真正的周杰伦版本在QQ Music出现时，它得到了40分（最高分）
2. **原唱经常不可用** - 由于版权保护，许多热门艺人的歌词在API中不可用
3. **程序选择最佳可用选项** - 如果原唱不可用，程序会选择得分最高的可用选项
4. **日志完全透明** - 现在你可以看到程序尝试了什么，以及为什么做出某个选择

#### 受影响的艺人（版权保护严格）
- 周杰伦
- 林俊杰
- 五月天
- 其他主流华语和国际艺人

### 💡 使用建议

1. **查看控制台输出** - 详细日志会告诉你整个过程
2. **理解版权限制** - 某些歌曲在所有平台都无法获取
3. **使用测试工具** - 运行 `python3 test_all_sources.py` 来查看各个平台的情况
4. **手动补充** - 对于无法自动下载的歌曲，可以手动从其他来源获取

### 🔧 技术细节

**修改的文件：**
- `core/lrc_sources.py` - 添加详细日志（NetEase、KuGou、QQ Music）
- `main.py` - 添加macOS Mach Port错误抑制
- `README.md` - 更新故障排除部分
- 新增 `LOGGING_AND_TROUBLESHOOTING.md` - 详细指南
- 新增 `test_logging.py` - 测试脚本
- 新增 `test_all_sources.py` - 多源测试脚本

**日志增强位置：**
- 搜索API请求前
- 搜索结果接收后（显示评分）
- 每次歌词API尝试
- 成功/失败状态

### 📝 版权声明

本工具仅供个人学习和研究使用。请尊重音乐版权，不要用于商业用途。某些歌曲由于版权保护无法通过自动化工具获取，这是正常现象。
